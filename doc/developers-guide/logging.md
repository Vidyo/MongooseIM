# Logging

To use logger in your module, include

```erlang
-include("mongoose_logger.hrl").
```
or
```erlang
-include("mongoose.hrl").
```

# Logging macros

There are several macros for the most common logging levels:

```erlang
DEBUG("event=debug_event info=~1000p", [Arg]),
INFO_MSG("event=info_event info=~1000p", [Arg]),
WARNING_MSG("event=warning_event reason=~1000p", [Arg]),
ERROR_MSG("event=error_event reason=~1000p", [Arg]),
CRITICAL_MSG("event=critical_event reason=~1000p", [Arg]),
```

Use them in correspondence with the appropriate log level.
Please be mindful of what is logged and which log level is used for it.

# Logging levels

A system operator can choose the global log level by setting `loglevel` in `mongooseim.cfg`.

- level 8 – all
- level 7 – debug
- level 6 – info
- level 5 - notice
- level 4 - warning
- level 3 - error
- level 2 - critical
- level 1 - alert
- level 0 - emergency

If a user sets the log level to `all`, then they would see all messages in logs.

Levels `warning` and `error` are the most commonly used for production systems.

# Logging format

We use a modified [logfmt](https://brandur.org/logfmt) format.

This format is [Splunk](https://www.splunk.com/en_us/solutions/solution-areas/log-management.html)
and [ELK](https://www.elastic.co/elk-stack) friendly.

`event=something_interesting` field is required.

`reason=~1000p` field is commonly used.

```erlang
    ?ERROR_MSG("event=check_password_failed "
               "reason=~p user=~ts", [Error, LUser]),

    try ...
    catch
        Class:Reason:StackTrace ->
            ?ERROR_MSG("event=check_password_failed "
                       "reason=~p:~p user=~ts stacktrace=~1000p",
                       [Class, Reason, LUser, StackTrace]),
            erlang:raise(Class, Reason, StackTrace)
    end
```

`user=~ts` is often used too.

A common way to name an error event is `event=function_name_failed`.
For example, `event=remove_user_failed`. Use the advice critically, it would
not work well for any function. Counter example:

```erlang
handle_info(Info, State) ->
    ?ERROR_MSG("issue=unexpected_info_received info=~1000p", [Info]),
    {noreply, State}.
```

Log messages should not contain new lines.

We usually use `~1000p` to log long data structures.

Use whitespace as a field separator:

```erlang
%% Use
?ERROR_MSG("event=check_password_failed reason=~p", [Reason])

%% Don't use
?ERROR_MSG("event=check_password_failed, reason=~p", [Reason])
```

# Filtering logs by module

Setting loglevel to `debug` can lead to a flood of messages in logs.
To set a different loglevel for just one module, call:

```erlang
mongoose_logs:set_global_loglevel(error).
mongoose_logs:set_module_loglevel(mod_mam, debug).
```

This code sets the loglevel to error for all log messages, except for those generated by `mod_mam`.
All messages from `mod_mam` would be logged.
